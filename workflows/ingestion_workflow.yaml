# src/ingestion/workflow.yaml
main:
  steps:
      - init:
              assign:
                        - project_id: "profitscout-lx6bb"
                                  - region: "us-central1"
                                            - price_updater_name: "refresh-prices"
                                                      - news_fetcher_name: "fetch-news"
                                                                - fundamentals_name: "refresh-fundamentals"
                                                                          - technicals_name: "refresh-technicals"
                                                                                    - sec_extractor_name: "extract-sec-filings"
                                                                                              - refresh_financials_name: "refresh-financials"
                                                                                                        - price_data_populator_name: "populate-price-data"
                                                                                                                  - refresh_stock_metadata_name: "refresh-stock-metadata"
                                                                                                                            - refresh_calendar_events_name: "refresh-calendar-events"
                                                                                                                                      - enrichment_workflow_id: "profitscout-enrichment-workflow"

                                                                                                                                          - call_price_updater:
                                                                                                                                                  call: http.post
                                                                                                                                                          args:
                                                                                                                                                                    url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + price_updater_name}
                                                                                                                                                                              auth: { type: OIDC }
                                                                                                                                                                                        timeout: 1800

                                                                                                                                                                                            - call_fundamentals:
                                                                                                                                                                                                    call: http.post
                                                                                                                                                                                                            args:
                                                                                                                                                                                                                      url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + fundamentals_name}
                                                                                                                                                                                                                                auth: { type: OIDC }
                                                                                                                                                                                                                                          timeout: 1800

                                                                                                                                                                                                                                              - call_technicals:
                                                                                                                                                                                                                                                      call: http.post
                                                                                                                                                                                                                                                              args:
                                                                                                                                                                                                                                                                        url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + technicals_name}
                                                                                                                                                                                                                                                                                  auth: { type: OIDC }
                                                                                                                                                                                                                                                                                            timeout: 1800

                                                                                                                                                                                                                                                                                                - call_sec_extractor:
                                                                                                                                                                                                                                                                                                        call: http.post
                                                                                                                                                                                                                                                                                                                args:
                                                                                                                                                                                                                                                                                                                          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + sec_extractor_name}
                                                                                                                                                                                                                                                                                                                                    auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                              timeout: 1800

                                                                                                                                                                                                                                                                                                                                                  - call_refresh_financials:
                                                                                                                                                                                                                                                                                                                                                          call: http.post
                                                                                                                                                                                                                                                                                                                                                                  args:
                                                                                                                                                                                                                                                                                                                                                                            url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + refresh_financials_name}
                                                                                                                                                                                                                                                                                                                                                                                      auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                                                                                timeout: 1800

                                                                                                                                                                                                                                                                                                                                                                                                    - call_price_data_populator:
                                                                                                                                                                                                                                                                                                                                                                                                            call: http.post
                                                                                                                                                                                                                                                                                                                                                                                                                    args:
                                                                                                                                                                                                                                                                                                                                                                                                                              url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + price_data_populator_name}
                                                                                                                                                                                                                                                                                                                                                                                                                                        auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                                                                                                                                  timeout: 1800

                                                                                                                                                                                                                                                                                                                                                                                                                                                      - call_refresh_stock_metadata:
                                                                                                                                                                                                                                                                                                                                                                                                                                                              call: http.post
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + refresh_stock_metadata_name}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    timeout: 1800

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - call_refresh_calendar_events:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                call: http.post
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + refresh_calendar_events_name}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      timeout: 1800

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - call_news_fetcher:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  call: http.post
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + news_fetcher_name}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              auth: { type: OIDC }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timeout: 1800

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - trigger_enrichment_workflow:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.create
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      parent: ${"projects/" + project_id + "/locations/" + region + "/workflows/" + enrichment_workflow_id}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              result: enrichment_execution

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - log_finish:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          call: sys.log
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            text: "Main data collection workflow finished successfully. Triggered Enrichment Workflow."

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - done:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return: "Workflow finished successfully."