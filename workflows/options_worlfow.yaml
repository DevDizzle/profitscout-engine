# src/serving/workflow.yaml
main:
  steps:
    - init:
        assign:
          - project_id: "profitscout-lx6bb"
          - region: "us-central1"
          - options_fetcher_name: "options-fetcher"
          - options_feature_engineering_name: "options-feature-engineering"
          - options_selector_name: "options-selector"
          - options_analyzer_name: "options-analyzer"
          - data_bundler_name: "data-bundler"
          - winners_dashboard_generator_name: "run-winners-dashboard-generator"
          # Remaining sync functions
          - sync_to_firestore_name: "sync-to-firestore"
          - sync_calendar_to_firestore_name: "run-sync-calendar-to-firestore"
          - sync_winners_to_firestore_name: "run-sync-winners-to-firestore"

    # Step 1: Run the options data pipeline
    - call_options_fetcher:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + options_fetcher_name}
          auth: { type: OIDC }
          timeout: 1800
        result: options_fetcher_result

    # Step 2: Selector runs first to filter candidates
    - call_options_selector:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + options_selector_name}
          auth: { type: OIDC }
          timeout: 900
        result: options_selector_result

    # Step 3: Feature Engineering runs on selected candidates
    - call_options_feature_engineering:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + options_feature_engineering_name}
          auth: { type: OIDC }
          timeout: 1800
        result: options_feature_engineering_result

    - call_options_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + options_analyzer_name}
          auth: { type: OIDC }
          timeout: 1800
        result: options_analyzer_result

    # Step 1.5: Bundle outputs for downstream consumers
    - call_data_bundler:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + data_bundler_name}
          auth: { type: OIDC }
          timeout: 1200
        result: data_bundler_result

    # Step 2: Generate the main winners dashboard table
    - call_winners_dashboard_generator:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + winners_dashboard_generator_name}
          auth: { type: OIDC }
          timeout: 900
        result: winners_dashboard_result

    # Step 3: Sync remaining data to Firestore in parallel
    - final_sync_to_firestore:
        parallel:
          branches:
            - run_sync_main:
                steps:
                  - call_sync_to_firestore:
                      call: http.post
                      args:
                        url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + sync_to_firestore_name}
                        auth: { type: OIDC }
                        timeout: 900
                        body:
                          full_reset: true
                      result: sync_main_result

            - run_sync_calendar:
                steps:
                  - call_sync_calendar_to_firestore:
                      call: http.post
                      args:
                        url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + sync_calendar_to_firestore_name}
                        auth: { type: OIDC }
                        timeout: 900
                      result: sync_calendar_result

            - run_sync_winners:
                steps:
                  - call_sync_winners_to_firestore:
                      call: http.post
                      args:
                        url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + sync_winners_to_firestore_name}
                        auth: { type: OIDC }
                        timeout: 900
                      result: sync_winners_result

    - log_finish:
        call: sys.log
        args:
          text: "Options and Final Sync workflow finished successfully."

    - done:
        return: "Workflow finished successfully."