main:
  steps:
    - init:
        assign:
          - project_id: "profitscout-lx6bb"
          - region: "us-central1"
          - financials_analyzer_name: "financials-analyzer"
          - fundamentals_analyzer_name: "fundamentals-analyzer"
          - technicals_analyzer_name: "technicals-analyzer"
          - mda_analyzer_name: "mda-analyzer"
          - transcript_analyzer_name: "transcript-analyzer"
          - macro_thesis_generator_name: "macro-thesis-generator"
          - news_analyzer_name: "news-analyzer"
          - business_summarizer_name: "business-summarizer"
          - price_chart_generator_name: "run-price-chart-generator"
          - serving_workflow_id: "profitscout-serving-workflow"

    - call_financials_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + financials_analyzer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_fundamentals_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + fundamentals_analyzer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_technicals_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + technicals_analyzer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_mda_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + mda_analyzer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_transcript_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + transcript_analyzer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_macro_thesis_generator:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + macro_thesis_generator_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_news_analyzer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + news_analyzer_name}'
            auth: { type: OIDC }
            timeout: 1200
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_business_summarizer:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + business_summarizer_name}'
            auth: { type: OIDC }
            timeout: 900
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - call_price_chart_generator:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-" + project_id + ".cloudfunctions.net/" + price_chart_generator_name}'
            auth:
              type: OIDC
            timeout: 900
          result: price_chart_result
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 2
            max_delay: 60
            multiplier: 2

    - trigger_serving_workflow:
        call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.create
        args:
          parent: ${"projects/" + project_id + "/locations/" + region + "/workflows/" + serving_workflow_id}
        result: serving_execution

    - log_finish:
        call: sys.log
        args:
          text: "Enrichment workflow finished successfully. Triggered Serving Workflow."

    - done:
        return: "Workflow finished successfully."