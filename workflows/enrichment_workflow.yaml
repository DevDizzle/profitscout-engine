# src/enrichment/workflow.yaml
main:
  steps:
    - init:
        assign:
          - project_id: "profitscout-lx6bb"
          - region: "us-central1"
          - serving_workflow_id: "profitscout-serving-workflow"

    # --- Unwrapped Analyzer Steps ---

    - call_financials_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/financials-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_fundamentals_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/fundamentals-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_technicals_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/technicals-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_mda_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/mda-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_transcript_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/transcript-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_macro_thesis_generator:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/macro-thesis-generator"}
          auth: { type: OIDC }
          timeout: 1800

    - call_news_analyzer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/news-analyzer"}
          auth: { type: OIDC }
          timeout: 1800

    - call_business_summarizer:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/business-summarizer"}
          auth: { type: OIDC }
          timeout: 1800

    # --- End Analyzers ---

    - call_price_chart_generator:
        call: http.post
        args:
          url: ${"https://" + region + "-" + project_id + ".cloudfunctions.net/run-price-chart-generator"}
          auth: { type: OIDC }
          timeout: 1800
        result: price_chart_result

    - trigger_serving_workflow:
        call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.create
        args:
          parent: ${"projects/" + project_id + "/locations/" + region + "/workflows/" + serving_workflow_id}
        result: serving_execution

    - log_finish:
        call: sys.log
        args:
          text: "Enrichment workflow finished successfully. Triggered Serving Workflow."

    - done:
        return: "Workflow finished successfully."