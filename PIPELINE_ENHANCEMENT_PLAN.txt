# PROFITSCOUT-ENGINE PIPELINE ENHANCEMENT PLAN
# Created: 2026-02-01 by GammaMolt (AI CEO, GammaRips)
# Status: PLANNING ONLY - No code changes

================================================================================
SECTION 1: CURRENT STATE ANALYSIS
================================================================================

## Pipeline Architecture
- Ingestion → Enrichment → Serving (3-stage pipeline)
- Cloud Functions + Cloud Workflows on GCP
- BigQuery for data storage
- Firestore for serving layer
- GCS for intermediate artifacts

## Current CI/CD (.github/workflows/ci.yml)
- ✅ Black linting (format check)
- ✅ Pytest execution
- ❌ No test coverage reporting
- ❌ No automated deployment
- ❌ No branch protection enforcement
- ❌ No integration tests in CI

## Current Test Coverage
- tests/enrichment/ (5 test files)
- tests/ingestion/ (3 test files)
- tests/serving/ (4 test files)
- tests/utils/ (1 test file)
- Unknown coverage percentage

================================================================================
SECTION 2: PREDICTABILITY ENHANCEMENTS
================================================================================

## 2.1 Signal Quality Improvements

### A. Model Performance Tracking
- Add daily accuracy logging to BigQuery
- Track: Predicted vs Actual outcomes
- Metrics: Win rate, avg return, Sharpe ratio
- Table: `signal_performance_history`

### B. Feature Engineering Review
- Audit current features in options enrichment
- Consider adding:
  - IV percentile (vs 52-week range)
  - Put/Call ratio trends
  - Sector momentum correlation
  - Earnings proximity factor

### C. Backtesting Pipeline
- Build historical backtester for signals
- Run nightly on past 30 days
- Flag degradation in model performance
- Alert if win rate drops below threshold

## 2.2 Data Quality Gates

### A. Ingestion Validation
- Schema validation on all incoming data
- Null/zero checks for critical fields
- Staleness detection (data age > 24h = alert)
- Duplicate detection

### B. Enrichment Validation  
- Output schema enforcement
- Range checks (e.g., IV between 0-500%)
- Consistency checks across related fields
- LLM output validation (JSON schema)

### C. Serving Validation
- Pre-publish sanity checks
- Compare today vs yesterday (anomaly detection)
- Block publish if data looks corrupted

================================================================================
SECTION 3: CI/CD ENHANCEMENT PLAN
================================================================================

## 3.1 Enhanced GitHub Actions Workflow

### Phase 1: Improved Testing (Week 1)
```yaml
# Proposed additions to ci.yml:
- name: Run tests with coverage
  run: |
    pip install pytest-cov
    pytest --cov=src --cov-report=xml --cov-report=term

- name: Upload coverage report
  uses: codecov/codecov-action@v3
  with:
    files: ./coverage.xml
```

### Phase 2: Linting & Type Checking (Week 1)
```yaml
- name: Type check with mypy
  run: |
    pip install mypy types-requests
    mypy src/ --ignore-missing-imports

- name: Security scan with bandit
  run: |
    pip install bandit
    bandit -r src/ -ll
```

### Phase 3: Integration Tests (Week 2)
```yaml
- name: Integration tests
  env:
    GCP_PROJECT: ${{ secrets.GCP_PROJECT_TEST }}
  run: |
    pytest tests/integration/ -v
```

### Phase 4: Automated Deployment (Week 3)
```yaml
deploy:
  needs: build
  if: github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest
  steps:
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Deploy Cloud Functions
      run: |
        ./scripts/deploy_all.sh
```

## 3.2 Branch Protection Rules

Recommend enabling on GitHub:
- Require PR reviews before merge
- Require status checks to pass (CI)
- Require branches to be up to date
- No direct pushes to main

## 3.3 Deployment Script

Create: scripts/deploy_all.sh
- Deploy all cloud functions
- Update workflow definitions
- Verify deployment health
- Rollback on failure

================================================================================
SECTION 4: IMPLEMENTATION ROADMAP
================================================================================

## Week 1: Foundation
- [ ] Add pytest-cov to CI
- [ ] Add mypy type checking
- [ ] Add bandit security scanning
- [ ] Set up Codecov integration
- [ ] Create branch protection rules

## Week 2: Testing
- [ ] Increase test coverage to 80%+
- [ ] Add integration test suite
- [ ] Add data validation tests
- [ ] Document testing patterns

## Week 3: Deployment
- [ ] Create deploy_all.sh script
- [ ] Add GCP authentication to CI
- [ ] Implement automated deployment
- [ ] Add deployment verification
- [ ] Implement rollback mechanism

## Week 4: Monitoring
- [ ] Add signal performance tracking
- [ ] Create daily performance dashboard
- [ ] Set up alerts for degradation
- [ ] Backtest validation pipeline

================================================================================
SECTION 5: SUCCESS METRICS
================================================================================

## CI/CD Metrics
- Build pass rate: >95%
- Test coverage: >80%
- Deploy frequency: Daily (automated)
- Mean time to recovery: <1 hour

## Predictability Metrics
- Signal win rate tracking (target: >55%)
- False positive rate: <20%
- Data freshness: <4 hours
- Zero critical data quality issues

================================================================================
SECTION 6: NOTES FOR EVAN
================================================================================

1. This plan is PLANNING ONLY - no code changes made
2. Gemini CLI can assist with implementation
3. Prioritize based on immediate needs:
   - If reliability is issue → Start with CI/CD
   - If accuracy is issue → Start with predictability
4. Consider costs: More tests = more CI minutes
5. The gammamolt-hello.txt file demonstrates I can coordinate with Gemini

================================================================================
END OF PLAN - GammaMolt, CEO, GammaRips
================================================================================
